<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Verification | SLP-ID</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        // --- GLOBAL TIMEOUT: AUTO-REDIRECT ---
        document.addEventListener('DOMContentLoaded', function () {
            const remaining = parseInt("{{ timeout|default(90) }}");
            // Update Visible Timer
            startVisibleTimer(remaining);

            // Auto Redirect
            if (remaining <= 0) {
                window.location.href = "/login?alert=timeout";
            } else {
                setTimeout(() => {
                    window.location.href = "/login?alert=timeout";
                }, remaining * 1000);
            }
        });

        function startVisibleTimer(seconds) {
            let sec = Math.floor(seconds);
            const interval = setInterval(() => {
                const el = document.getElementById('timer-display');
                if (el) el.innerText = sec + "s";
                sec--;
                if (sec < 0) clearInterval(interval);
            }, 1000);
        }
    </script>
    <style>
        body {
            background-color: #0f172a;
            /* Deep Navy */
            color: white;
            font-family: 'Segoe UI', Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        .security-container {
            text-align: center;
            max-width: 500px;
            width: 100%;
            padding: 40px;
        }

        .official-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
            opacity: 0.7;
            font-size: 12px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        h1 {
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        /* VISIBLE TIMER */
        .timer-header {
            text-align: center;
            margin-bottom: 15px;
        }


        p {
            color: #94a3b8;
            font-size: 15px;
            margin-bottom: 30px;
        }

        /* --- CHALLENGE PHRASE BOX --- */
        .challenge-box {
            background: #1e293b;
            border: 1px dashed #334155;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .challenge-label {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 8px;
            text-transform: uppercase;
            font-weight: bold;
        }

        .challenge-text {
            font-size: 20px;
            font-weight: bold;
            color: #fff;
            letter-spacing: 0.5px;
        }

        /* --- AUDIO VISUALIZER --- */
        .mic-wrapper {
            width: 80px;
            height: 80px;
            background: #1e293b;
            border-radius: 50%;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: #fff;
            position: relative;
            transition: all 0.3s;
        }

        /* The Pulse Animation (Hidden by default) */
        .mic-pulse {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid #0ea5e9;
            opacity: 0;
        }

        .recording .mic-wrapper {
            background: #ef4444;
            color: white;
            transform: scale(1.1);
        }

        .recording .mic-pulse {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            100% {
                transform: scale(2.5);
                opacity: 0;
            }
        }

        /* --- BUTTONS --- */
        .btn-record {
            background: #0ea5e9;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-record:hover {
            background: #0284c7;
        }

        .btn-record:disabled {
            background: #475569;
            cursor: not-allowed;
            box-shadow: none;
        }

        .status-msg {
            margin-top: 25px;
            min-height: 20px;
            font-size: 14px;
            color: #0ea5e9;
        }
    </style>
</head>

<body>

    <div class="security-container">
        <div class="official-badge">
            <img src="https://flagcdn.com/w40/my.png" alt="Malaysia" style="width: 20px; border-radius: 2px;">
            Voice Liveness Check
        </div>

        <!-- VISIBLE TIMER -->
        <div class="timer-header">
            <span style="font-size: 14px; color: #94a3b8;">Session expires in:</span>
            <span id="timer-display"
                style="font-weight: bold; color: #f59e0b; font-family: monospace; font-size: 16px;">90s</span>
        </div>

        <h1>Verify Your Voice</h1>
        <p>Please read the phrase below loudly and clearly to confirm your identity.</p>

        <div class="challenge-box">
            <div class="challenge-label">Read this phrase:</div>
            <div class="challenge-text" id="randomPhrase">"Loading..."</div>
        </div>

        <div class="mic-container" id="micContainer">
            <div class="mic-wrapper">
                <i class="fas fa-microphone"></i>
                <div class="mic-pulse"></div>
            </div>
        </div>

        <button class="btn-record" id="recordBtn" onclick="startVoiceScan()">
            <i class="fas fa-microphone"></i> Start Recording
        </button>

        <div class="status-msg" id="statusMsg"></div>
    </div>

    <script>
        // 1. List of Random Phrases
        const phrases = [
            "Kuala Lumpur is the capital city of Malaysia.",
            "The Petronas Twin Towers are very tall and impressive.",
            "Nasi lemak is a popular Malaysian dish.",
            "Mount Kinabalu is located in Sabah.",
            "The Penang Bridge connects Penang Island to the mainland.",
            "Durian is known as the king of fruits in Malaysia.",
            "Malacca has many historical buildings from the colonial era.",
            "The Malaysian flag has fourteen stripes and a crescent.",
            "Orangutans can be found in Sarawak and Sabah.",
            "The rainforest in Taman Negara is very dense and green.",
            "The Sultan Abdul Samad Building is in Kuala Lumpur.",
            "Rafflesia is the worldâ€™s largest flower and grows in Malaysia.",
            "The Langkawi Sky Bridge offers a breathtaking view.",
            "Malaysian Borneo has diverse wildlife and natural beauty.",
            "Traditional batik is a famous Malaysian art form."
        ];

        // 2. Function to pick a random phrase on load
        window.onload = function () {
            const randomIndex = Math.floor(Math.random() * phrases.length);
            document.getElementById('randomPhrase').innerText = `"${phrases[randomIndex]}"`;
        };

        // --- WAV ENCODING LOGIC ---
        let audioContext;
        let recorder;
        let input;

        function startVoiceScan() {
            const btn = document.getElementById('recordBtn');
            const container = document.getElementById('micContainer');
            const status = document.getElementById('statusMsg');

            btn.disabled = true;
            status.innerText = "Requesting microphone...";

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert("Your browser does not support audio recording.");
                return;
            }

            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 44100 });
                    input = audioContext.createMediaStreamSource(stream);

                    // Use a ScriptProcessorNode (deprecated but widely supported/simple for this single-file demo)
                    // Buffer size 4096, 1 input channel, 1 output channel
                    recorder = audioContext.createScriptProcessor(4096, 1, 1);

                    let leftChannel = [];

                    recorder.onaudioprocess = function (e) {
                        let samples = e.inputBuffer.getChannelData(0);
                        // Clone the samples
                        leftChannel.push(new Float32Array(samples));
                    };

                    input.connect(recorder);
                    recorder.connect(audioContext.destination);

                    // UI Updates
                    btn.innerHTML = '<i class="fas fa-stop"></i> Recording...';
                    container.classList.add('recording');
                    status.innerText = "Listening...";

                    // Stop automatically after 5 seconds
                    setTimeout(() => {
                        stopRecording(stream, leftChannel);
                    }, 5000);
                })
                .catch(err => {
                    console.error("Error accessing microphone:", err);
                    status.innerText = "Microphone access denied.";
                    btn.disabled = false;
                });
        }

        function stopRecording(stream, leftChannel) {
            const btn = document.getElementById('recordBtn');
            const container = document.getElementById('micContainer');
            const status = document.getElementById('statusMsg');

            // Stop recording
            recorder.disconnect();
            input.disconnect();
            stream.getTracks().forEach(track => track.stop());

            container.classList.remove('recording');
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Processing...';
            status.innerText = "Encoding & Verifying...";

            // Flatten buffer
            let recordingLength = leftChannel.length * 4096;
            let flatData = new Float32Array(recordingLength);
            let offset = 0;
            for (let i = 0; i < leftChannel.length; i++) {
                flatData.set(leftChannel[i], offset);
                offset += leftChannel[i].length;
            }

            // Encode to WAV
            const wavBlob = encodeWAV(flatData);
            sendAudioData(wavBlob);
        }

        function encodeWAV(samples) {
            let buffer = new ArrayBuffer(44 + samples.length * 2);
            let view = new DataView(buffer);

            // Write WAV Header
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + samples.length * 2, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // PCM
            view.setUint16(22, 1, true); // Mono
            view.setUint32(24, 44100, true);
            view.setUint32(28, 44100 * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, samples.length * 2, true);

            // Write PCM Samples
            floatTo16BitPCM(view, 44, samples);

            return new Blob([view], { type: 'audio/wav' });
        }

        function floatTo16BitPCM(output, offset, input) {
            for (let i = 0; i < input.length; i++, offset += 2) {
                let s = Math.max(-1, Math.min(1, input[i]));
                output.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
            }
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        function sendAudioData(audioBlob) {
            const btn = document.getElementById('recordBtn');
            const status = document.getElementById('statusMsg');

            const formData = new FormData();
            formData.append("audio", audioBlob, "recording.wav");

            // Get the displayed phrase (remove quotes)
            const phraseText = document.getElementById('randomPhrase').innerText.replace(/^"|"$/g, '');
            formData.append("phrase", phraseText);

            fetch('/verify-voice', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        status.innerText = data.message + (data.transcript ? ` You said: "${data.transcript}"` : "");
                        status.style.color = "#10b981"; // Green
                        setTimeout(() => {
                            window.location.href = "/step-complete";
                        }, 2000);
                    } else {
                        status.innerText = "Verification Failed: " + data.message;
                        status.style.color = "#ef4444"; // Red
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-microphone"></i> Retry';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    status.innerText = "Server Error. Please try again.";
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-microphone"></i> Retry';
                });
        }
    </script>
</body>

</html>