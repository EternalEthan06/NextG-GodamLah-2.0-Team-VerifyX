{% extends "base.html" %}

{% block title %}Share Capsule | VerifyX{% endblock %}

{% block styles %}
<style>
    /* Override base main-content for centering */
    .main-content {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        /* Changed from height:100vh */
        height: auto;
    }

    .container {
        background: white;
        width: 100%;
        max-width: 1100px;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        display: flex;
        min-height: 750px;
        /* Changed from height:750px */
        height: auto;
        flex-direction: row;
        /* Default row */
    }

    @media (max-width: 1024px) {
        .container {
            flex-direction: column;
            /* Stack on smaller screens */
        }

        .form-panel {
            border-right: none;
            border-bottom: 1px solid #eee;
        }
    }

    /* --- LEFT PANEL: FORM --- */
    .form-panel {
        flex: 1;
        padding: 30px;
        overflow-y: auto;
        border-right: 1px solid #eee;
    }

    .header h2 {
        margin: 0;
        color: var(--gov-blue);
        font-size: 24px;
    }

    .header p {
        color: #666;
        margin-top: 5px;
        font-size: 14px;
    }

    .section-label {
        font-size: 11px;
        font-weight: 700;
        color: #888;
        text-transform: uppercase;
        margin-bottom: 8px;
        display: block;
        letter-spacing: 0.5px;
    }

    .input-group {
        margin-bottom: 20px;
    }

    select,
    input[type="date"],
    input[type="time"] {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 13px;
        background: #fff;
        color: #333;
        width: 100%;
    }

    .datetime-grid {
        display: grid;
        grid-template-columns: 1.5fr 1fr;
        gap: 10px;
        margin-bottom: 10px;
    }

    .permission-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        border: 1px solid #eee;
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: 0.2s;
    }

    .permission-item:hover,
    .permission-item.active {
        border-color: var(--gov-blue);
        background: #f8fafc;
        box-shadow: 0 2px 8px rgba(0, 51, 102, 0.05);
    }

    .perm-info h4 {
        margin: 0;
        font-size: 14px;
        color: #333;
    }

    .perm-info p {
        margin: 2px 0 0;
        font-size: 11px;
        color: #888;
    }

    .switch {
        position: relative;
        display: inline-block;
        width: 40px;
        height: 22px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 34px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    input:checked+.slider {
        background-color: var(--gov-blue);
    }

    input:checked+.slider:before {
        transform: translateX(18px);
    }

    input:disabled+.slider {
        background-color: #94a3b8;
        opacity: 0.5;
    }

    /* --- RECIPIENT INPUT STYLING --- */
    .fancy-input-group {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 5px;
        transition: 0.2s;
        display: flex;
        align-items: center;
    }

    .fancy-input-group:focus-within {
        border-color: var(--gov-blue);
        box-shadow: 0 0 0 3px rgba(22, 59, 130, 0.1);
        background: white;
    }

    .fancy-input-group i {
        color: #94a3b8;
        padding: 0 15px;
        font-size: 16px;
    }

    .fancy-input-group input {
        border: none;
        background: transparent;
        padding: 12px 0;
        font-size: 15px;
        width: 100%;
        outline: none;
        color: #333;
        font-weight: 500;
    }

    .countdown-circle {
        position: relative;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 10px;
    }

    .countdown-svg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transform: rotate(-90deg);
    }

    .countdown-circle-bg {
        fill: none;
        stroke: #eee;
        stroke-width: 4;
    }

    .countdown-circle-path {
        fill: none;
        stroke: var(--gov-blue);
        stroke-width: 4;
        stroke-dasharray: 176;
        /* 2 * PI * 28 */
        stroke-dashoffset: 0;
        transition: stroke-dashoffset 1s linear;
    }

    .countdown-text {
        font-size: 14px;
        font-weight: bold;
        color: #333;
    }

    .btn-share {
        width: 100%;
        padding: 15px;
        background: var(--gov-blue);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        margin-top: 15px;
    }

    .btn-share:hover {
        background: var(--gov-dark);
    }

    /* --- RIGHT PANEL: DOCUMENT PREVIEW --- */
    .preview-panel {
        flex: 1.2;
        background: #eef2f6;
        padding: 40px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .doc-sheet {
        background: white;
        width: 100%;
        height: 100%;
        border-radius: 8px;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.08);
        border: 1px solid #d1d5db;
        padding: 40px;
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .verification-stamp {
        position: absolute;
        top: 20px;
        right: 20px;
        border: 2px solid var(--success);
        color: var(--success);
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        transform: rotate(-5deg);
        opacity: 0.8;
        background: rgba(16, 185, 129, 0.05);
    }

    .official-seal {
        width: 80px;
        height: 80px;
        position: absolute;
        bottom: 30px;
        right: 30px;
        opacity: 0.15;
        filter: grayscale(100%);
    }

    .doc-header {
        border-bottom: 2px solid #333;
        padding-bottom: 10px;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .authority-logo {
        font-size: 32px;
        color: #333;
    }

    .doc-title {
        font-size: 20px;
        font-weight: 800;
        color: #111;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .doc-subtitle {
        font-size: 10px;
        color: #666;
        text-transform: uppercase;
    }

    .field-row {
        margin-bottom: 18px;
    }

    .field-label {
        font-size: 10px;
        color: #6b7280;
        text-transform: uppercase;
        margin-bottom: 2px;
    }

    .field-value {
        font-size: 15px;
        color: #111;
        font-weight: 600;
        font-family: 'Courier New', monospace;
        letter-spacing: -0.5px;
    }

    /* WATERMARK STYLE */
    .watermark-big {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-30deg);
        font-size: 80px;
        font-weight: 900;
        color: rgba(0, 0, 0, 0.08);
        border: 8px solid rgba(0, 0, 0, 0.08);
        padding: 10px 40px;
        border-radius: 20px;
        pointer-events: none;
        white-space: nowrap;
        z-index: 0;
        user-select: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">

    <!-- LEFT PANEL: TABS + FORMS (Wrapped in .form-panel for layout) -->
    <div class="form-panel">
        <div class="header" style="margin-bottom: 20px;">
            <h2><i class="fas fa-shield-halved"></i> Share Capsule</h2>
            <p>Configure access time and permissions for {{ user.full_name }}'s data.</p>
        </div>

        <form action="/create_share" method="POST">
            <!-- EXISTING FORM CONTENT PRESERVED -->
            <div class="input-group">
                <label class="section-label">Recipient Type</label>
                <div class="fancy-input-group">
                    <i class="fas fa-user-tag"></i>
                    <select name="recipient_type" id="recipientType" onchange="toggleRecipientInput()" required
                        style="border:none; padding:12px 0; width:100%; outline:none; background:transparent;">
                        <option value="" disabled selected>Select Recipient Type...</option>
                        <option value="Individual">Individual (Citizen)</option>
                        <option value="Government">Government Agency</option>
                        <option value="Private">Private Company</option>
                    </select>
                </div>
            </div>

            <div class="input-group" id="recipientInputGroup" style="display:none; margin-top: 15px;">
                <label class="section-label" id="recipientLabel">Recipient ID</label>
                <div class="fancy-input-group">
                    <i class="fas fa-id-card-clip"></i>
                    <input type="text" name="recipient_id" id="recipientId" placeholder="Enter ID...">
                </div>
            </div>

            <label class="section-label" style="margin-top:20px">Access Window</label>
            <div class="datetime-grid">
                <div>
                    <label style="font-size:10px; color:#888;">Start Date</label>
                    <input type="date" name="start_date" required>
                </div>
                <div>
                    <label style="font-size:10px; color:#888;">Time</label>
                    <input type="time" name="start_time" value="09:00" required>
                </div>
            </div>
            <div class="datetime-grid">
                <div>
                    <label style="font-size:10px; color:#888;">End Date</label>
                    <input type="date" name="end_date" required>
                </div>
                <div>
                    <label style="font-size:10px; color:#888;">Time</label>
                    <input type="time" name="end_time" value="18:00" required>
                </div>
            </div>

            <label class="section-label" style="margin-top:20px;">Documents (7 Available)</label>

            <!-- PERMISSION ITEMS (Truncated for brevity in replacement, ideally specific replacement) -->
            <!-- But we need to wrap the whole form area to put it in a tab -->

            <!-- RE-INSERTING PERMISSION ITEMS FOR CONTEXT -->
            <div class="permission-item active" data-doc-type="identity" onclick="showPreview('identity', this)">
                <div class="perm-info">
                    <h4><i class="fas fa-id-card"></i> Identity Card</h4>
                    <p>Verified by JPN</p>
                </div>
                <label class="switch">
                    <input type="checkbox" checked disabled><span class="slider"></span>
                </label>
            </div>

            <div class="permission-item" data-doc-type="license" onclick="showPreview('license', this)">
                <div class="perm-info">
                    <h4><i class="fas fa-car"></i> Driving License</h4>
                    <p>Verified by JPJ Malaysia</p>
                </div>
                <label class="switch">
                    <input type="checkbox" name="share_license"><span class="slider"></span>
                </label>
            </div>

            <div class="permission-item" data-doc-type="income" onclick="showPreview('income', this)">
                <div class="perm-info">
                    <h4><i class="fas fa-file-invoice-dollar"></i> Income Slip</h4>
                    <p>Verified by Public Bank</p>
                </div>
                <label class="switch">
                    <input type="checkbox" name="share_income"><span class="slider"></span>
                </label>
            </div>

            <div class="permission-item" data-doc-type="transcript" onclick="showPreview('transcript', this)">
                <div class="perm-info">
                    <h4><i class="fas fa-graduation-cap"></i> Academic Transcript</h4>
                    <p>Verified by University of Malaya</p>
                </div>
                <label class="switch">
                    <input type="checkbox" name="share_transcript"><span class="slider"></span>
                </label>
            </div>

            <div class="permission-item" data-doc-type="vaccine" onclick="showPreview('vaccine', this)">
                <div class="perm-info">
                    <h4><i class="fas fa-syringe"></i> Vaccination Cert</h4>
                    <p>Verified by MOH (MySejahtera)</p>
                </div>
                <label class="switch">
                    <input type="checkbox" name="share_vaccine"><span class="slider"></span>
                </label>
            </div>

            <div class="permission-item" data-doc-type="epf" onclick="showPreview('epf', this)">
                <div class="perm-info">
                    <h4><i class="fas fa-coins"></i> EPF Statement</h4>
                    <p>Verified by KWSP</p>
                </div>
                <label class="switch">
                    <input type="checkbox" name="share_epf"><span class="slider"></span>
                </label>
            </div>

            <div class="permission-item" data-doc-type="birth" onclick="showPreview('birth', this)">
                <div class="perm-info">
                    <h4><i class="fas fa-certificate"></i> Birth Certificate</h4>
                    <p>Verified by JPN</p>
                </div>
                <label class="switch">
                    <input type="checkbox" name="share_birth"><span class="slider"></span>
                </label>
            </div>

            <button type="button" class="btn-share" onclick="submitShare()">Generate Share Capsule</button>
        </form>
    </div>

    <div class="preview-panel">
        <div class="doc-sheet" id="preview-area">

            <div class="watermark-big">PREVIEW</div>
            <label class="section-label"
                style="position: absolute; bottom: 15px; left: 20px; z-index: 10; background: white; padding: 2px 8px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                Live Preview
            </label>

            <div class="verification-stamp" id="stamp-box">
                <i class="fas fa-check-circle"></i> VERIFIED: JPN
            </div>
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/26/Coat_of_arms_of_Malaysia.svg/1200px-Coat_of_arms_of_Malaysia.svg.png"
                class="official-seal">

            <div class="doc-header">
                <i class="fas fa-id-card authority-logo" id="auth-icon"></i>
                <div>
                    <div class="doc-title" id="doc-title">IDENTITY CARD</div>
                    <div class="doc-subtitle" id="doc-source">JABATAN PENDAFTARAN NEGARA</div>
                </div>
            </div>

            <div id="doc-content">
            </div>
        </div>
    </div>
</div>

<!-- SUCCESS MODAL -->
<div id="shareModal" class="modal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div
        style="background:white; padding:40px; border-radius:16px; width:400px; text-align:center; box-shadow:0 20px 50px rgba(0,0,0,0.2);">
        <div
            style="display:flex; flex-direction:column; align-items:center; justify-content:center; gap:5px; margin-bottom:20px;">
            <div class="countdown-circle" style="margin:0;">
                <svg class="countdown-svg">
                    <circle class="countdown-circle-bg" cx="30" cy="30" r="28"></circle>
                    <circle class="countdown-circle-path" id="countdownPath" cx="30" cy="30" r="28"></circle>
                </svg>
                <div class="countdown-text" id="countdownText">60</div>
            </div>
            <div style="font-size:12px; color:#999; text-align:center; font-weight:500;">
                Seconds Remaining
            </div>
        </div>
        <h2 style="color:var(--gov-blue); margin-top:0;">Share Active!</h2>
        <p style="color:#666; font-size:14px;">The recipient can scan this QR or enter the code below.</p>

        <div id="qrContainer"
            style="margin:20px 0; border:1px solid #eee; padding:10px; display:inline-block; border-radius:8px;">
            <!-- QR Image injected here -->
            <img id="qrImage" src="" width="180">
        </div>

        <div style="background:#f1f5f9; padding:15px; border-radius:8px; margin-bottom:20px;">
            <div style="font-size:12px; color:#888; text-transform:uppercase; font-weight:bold;">Share Code</div>
            <div id="otpCode"
                style="font-size:32px; font-weight:900; letter-spacing:5px; color:#333; font-family:monospace;">
                ------
            </div>


        </div>

        <button onclick="closeModal()"
            style="background:#eee; color:#333; border:none; padding:10px 20px; border-radius:6px; cursor:pointer;">Close</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // AUTO-SET DATES
    const today = new Date().toISOString().split('T')[0];
    document.querySelector('input[name="start_date"]').value = today;
    document.querySelector('input[name="end_date"]').value = today;

    // --- HANDLE DIRECT SHARE PRE-SELECTION ---
    document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const preselectKey = urlParams.get('preselect_doc');

        if (preselectKey) {
            // Find the permission item
            const item = document.querySelector(`.permission-item[data-doc-type="${preselectKey}"]`);
            if (item) {
                // 1. Scroll into view
                item.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // 2. Trigger Preview
                showPreview(preselectKey, item);

                // 3. Check the checkbox (if not disabled/identity)
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox && !checkbox.disabled) {
                    checkbox.checked = true;
                    // Trigger slider visual change if needed (but CSS handles :checked)
                }
            }
        }
    });

    // --- NEW SHARE LOGIC ---
    function toggleRecipientInput() {
        const type = document.getElementById('recipientType').value;
        const group = document.getElementById('recipientInputGroup');
        const label = document.getElementById('recipientLabel');
        const input = document.getElementById('recipientId');

        if (type === 'Individual') {
            group.style.display = 'block';
            label.innerText = 'Recipient MyKad Number';
            input.placeholder = 'e.g. 123456-78-1234';
        } else if (type === 'Government') {
            group.style.display = 'block';
            label.innerText = 'Agency Code';
            input.placeholder = 'e.g. JPN-8821';
        } else if (type === 'Private') {
            group.style.display = 'block';
            label.innerText = 'Company Registration No';
            input.placeholder = 'e.g. 199901012345 (45678-A)';
        } else {
            group.style.display = 'none';
        }
    }

    let currentShareId = null;
    let pollInterval = null;
    let countdownInterval = null;
    let timeLeft = 60;

    function submitShare() {
        const type = document.getElementById('recipientType').value;
        const id = document.getElementById('recipientId').value;

        if (!type || (type !== '' && !id)) {
            alert("Please select a recipient and enter their ID.");
            return;
        }

        const formData = new FormData(document.querySelector('form'));

        fetch('/create_share', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    currentShareId = data.share_id;
                    showModal(data.otp_code, null);

                    // Force an immediate check to get the QR
                    fetchStatus();

                    // Start Countdown Loop
                    resetCountdown();
                } else {
                    alert("Error: " + data.message);
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function fetchStatus() {
        if (!currentShareId) return;
        fetch(`/share_status/${currentShareId}`)
            .then(r => r.json())
            .then(data => {
                if (data.status === 'active') {
                    // Update text/image if changed
                    document.getElementById('otpCode').innerText = data.code;
                    document.getElementById('qrImage').src = data.qr_image;
                } else {
                    console.log("Share expired");
                    closeModal();
                }
            });
    }

    function resetCountdown() {
        clearInterval(countdownInterval);
        timeLeft = 60;
        updateTimerUI();

        countdownInterval = setInterval(() => {
            timeLeft--;
            updateTimerUI();

            if (timeLeft <= 0) {
                // Timer finished: Fetch new code (Rotation on backend)
                fetchStatus();
                timeLeft = 60; // Restart loop
            }
        }, 1000);
    }

    function updateTimerUI() {
        const text = document.getElementById('countdownText');
        const path = document.getElementById('countdownPath');
        if (!text || !path) return;

        text.innerText = timeLeft;

        // Calculate stroke offset
        // Circumference = 2 * PI * 28 â‰ˆ 176
        const maxDash = 176;
        const dashOffset = maxDash - (timeLeft / 60) * maxDash;
        path.style.strokeDashoffset = dashOffset;
    }

    function showModal(code, qrImage) {
        document.getElementById('shareModal').style.display = 'flex';
        document.getElementById('otpCode').innerText = code;
        if (qrImage) {
            document.getElementById('qrImage').src = qrImage;
        }
    }

    function closeModal() {
        document.getElementById('shareModal').style.display = 'none';
        clearInterval(pollInterval);
        clearInterval(countdownInterval);
        currentShareId = null;
    }


    // DATA FOR PREVIEWS (Matching allFiles.html)
    const docs = {
        'identity': {
            title: 'IDENTITY CARD',
            source: 'JABATAN PENDAFTARAN NEGARA',
            icon: 'fa-id-card',
            stamp: 'VERIFIED: JPN GOV',
            color: '#003366',
            fields: [
                { label: 'Full Name', value: '{{ user.full_name | upper }}' },
                { label: 'MyKad No', value: '{{ user.mykad_number }}' },
                { label: 'Citizenship', value: 'WARGANEGARA' },
                { label: 'Address', value: '{{ user.address | upper }}' }
            ]
        },
        'license': {
            title: 'DRIVING LICENSE',
            source: 'JABATAN PENGANGKUTAN JALAN',
            icon: 'fa-car',
            stamp: 'VERIFIED: JPJ MALAYSIA',
            color: '#e65100',
            fields: [
                { label: 'Name', value: '{{ user.full_name | upper }}' },
                { label: 'Class', value: 'D (CAR), B2 (MOTOR)' },
                { label: 'Validity', value: 'VALID UNTIL 2028' },
                { label: 'Competency', value: 'FULL (CDL)' }
            ]
        },
        'income': {
            title: 'INCOME STATEMENT',
            source: 'LEMBAGA HASIL DALAM NEGERI',
            icon: 'fa-file-invoice-dollar',
            stamp: 'VERIFIED: PUBLIC BANK',
            color: '#166534',
            fields: [
                { label: 'Tax Year', value: '2024' },
                { label: 'Total Income', value: 'RM 54,000.00' },
                { label: 'Tax Paid', value: 'RM 1,200.00' },
                { label: 'Status', value: 'CLEARED' }
            ]
        },
        'transcript': {
            title: 'ACADEMIC TRANSCRIPT',
            source: 'UNIVERSITY OF MALAYA',
            icon: 'fa-graduation-cap',
            stamp: 'VERIFIED: UM REGISTRAR',
            color: '#4338ca',
            fields: [
                { label: 'Student', value: '{{ user.full_name | upper }}' },
                { label: 'Program', value: 'BACHELOR OF COMPUTER SCIENCE' },
                { label: 'CGPA', value: '3.85 (FIRST CLASS)' },
                { label: 'Graduation', value: '2023' }
            ]
        },
        'vaccine': {
            title: 'VACCINATION CERT',
            source: 'MINISTRY OF HEALTH (MOH)',
            icon: 'fa-syringe',
            stamp: 'VERIFIED: MYSEJAHTERA',
            color: '#be123c',
            fields: [
                { label: 'Name', value: '{{ user.full_name | upper }}' },
                { label: 'Status', value: 'FULLY VACCINATED' },
                { label: 'Dose 1', value: 'PFIZER (BATCH FK001)' },
                { label: 'Dose 2', value: 'PFIZER (BATCH FK055)' }
            ]
        },
        'epf': {
            title: 'EPF MEMBER STATEMENT',
            source: 'KUMPULAN WANG SIMPANAN PEKERJA',
            icon: 'fa-coins',
            stamp: 'VERIFIED: KWSP',
            color: '#104099',
            fields: [
                { label: 'Member No', value: '109923881' },
                { label: 'Account 1', value: 'RM 45,200.50' },
                { label: 'Account 2', value: 'RM 12,100.25' },
                { label: 'Last Dividend', value: '5.4%' }
            ]
        },
        'birth': {
            title: 'CERTIFICATE OF BIRTH',
            source: 'JABATAN PENDAFTARAN NEGARA',
            icon: 'fa-certificate',
            stamp: 'VERIFIED: JPN GOV',
            color: '#0d9488',
            fields: [
                { label: 'Child Name', value: '{{ user.full_name | upper }}' },
                { label: 'Date of Birth', value: '{{ user.mykad_number[0:2] }}-{{ user.mykad_number[2:4] }}-{{ user.mykad_number[4:6] }}' },
                { label: 'Place of Birth', value: 'KUALA LUMPUR' },
                { label: 'Register No', value: 'D-882199' }
            ]
        }
    };

    function showPreview(type, el) {
        // 1. Highlight active list item
        document.querySelectorAll('.permission-item').forEach(item => item.classList.remove('active'));
        if (el) el.classList.add('active');

        // 2. Get Data Template
        const item = docs[type];

        // 3. Update UI Elements
        document.getElementById('doc-title').innerText = item.title;
        document.getElementById('doc-source').innerText = item.source;
        document.getElementById('stamp-box').innerHTML = `<i class="fas fa-check-circle"></i> ${item.stamp}`;
        document.getElementById('stamp-box').style.color = item.color;
        document.getElementById('stamp-box').style.borderColor = item.color;

        const icon = document.getElementById('auth-icon');
        icon.className = `fas ${item.icon} authority-logo`;
        icon.style.color = item.color;

        // 4. Render Fields
        const content = document.getElementById('doc-content');
        content.innerHTML = ''; // Clear old fields

        item.fields.forEach(field => {
            content.innerHTML += `
                <div class="field-row">
                    <div class="field-label">${field.label}</div>
                    <div class="field-value">${field.value}</div>
                </div>
            `;
        });
    }

    // Initialize: Set the Identity Card as the default view
    document.addEventListener('DOMContentLoaded', () => {
        // Get the default identity element
        const defaultItem = document.querySelector('.permission-item[data-doc-type="identity"]');
        // Trigger the preview
        showPreview('identity', defaultItem);
    });
</script>
{% endblock %}